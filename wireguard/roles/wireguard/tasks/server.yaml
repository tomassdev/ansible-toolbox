---
- name: Ensure WireGuard config directory exists
  ansible.builtin.file:
    path: /etc/wireguard
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Generate server private key
  ansible.builtin.shell: |
    umask 077
    wg genkey > /etc/wireguard/server_private.key
  args:
    creates: /etc/wireguard/server_private.key
  no_log: true

- name: Generate server public key
  ansible.builtin.shell: |
    umask 077
    wg pubkey < /etc/wireguard/server_private.key > /etc/wireguard/server_public.key
  args:
    creates: /etc/wireguard/server_public.key
  no_log: true

- name: Read server private and public keys
  ansible.builtin.slurp:
    path: "{{ item }}"
  register: _wireguard_keys
  loop:
    - /etc/wireguard/server_private.key
    - /etc/wireguard/server_public.key
  no_log: true

- name: Store server private and public keys
  ansible.builtin.set_fact:
    wireguard_server_private_key: >-
      {{ (_wireguard_keys.results
         | selectattr('source', 'equalto', '/etc/wireguard/server_private.key')
         | first).content | b64decode | trim }}
    wireguard_server_public_key: >-
      {{ (_wireguard_keys.results
         | selectattr('source', 'equalto', '/etc/wireguard/server_public.key')
         | first).content | b64decode | trim }}
  no_log: true

- name: Render server config without peers
  ansible.builtin.template:
    src: wg.conf.j2
    dest: "/etc/wireguard/{{ wg_interface }}.conf"
    owner: root
    group: root
    mode: "0600"
    validate: "sh -c 'wg-quick strip %s >/dev/null'"
  notify: Restart wireguard
  no_log: true
  when: wg_clients | length == 0

- name: Enable and start WireGuard service without peers
  ansible.builtin.systemd:
    name: "wg-quick@{{ wg_interface }}"
    enabled: true
    state: started
  when: wg_clients | length == 0
